---
# Ansible Playbook - Generated by InoPay NCS 2.0
- name: Deploy inopay to VPS
  hosts: web_servers
  become: yes
  vars:
    app_name: "inopay"
    app_dir: "/opt/apps/{{ app_name }}"
  tasks:
    - name: Update apt cache
      apt: update_cache=yes cache_valid_time=3600
      when: ansible_os_family == "Debian"
    - name: Install Docker
      apt: name=docker.io state=present
      when: ansible_os_family == "Debian"
    - name: Start Docker
      systemd: name=docker state=started enabled=yes
    - name: Create app directory
      file: path="{{ app_dir }}" state=directory mode='0755'
    - name: Copy application files
      synchronize: src=../ dest="{{ app_dir }}/" rsync_opts=["--exclude=.git","--exclude=node_modules"]
      delegate_to: localhost
    - name: Build and start
      command: docker compose up -d --build
      args:
        chdir: "{{ app_dir }}"
    - name: Verify health
      uri: url="http://localhost/" status_code=200
      register: health_check
      retries: 5
      delay: 5
